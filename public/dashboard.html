<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaxStats AI Dashboard</title>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-storage-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>

    <style>
        :root[data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --text-primary: #ffffff;
            --text-secondary: #b3b3b3;
            --accent: #23358b;
            --error: #ff4444;
            --success: #00C851;
        }

        body {
            margin: 0;
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }

        header {
            background-color: var(--bg-secondary);
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header img {
            width: 200px;  /* Increased from 80px */
            height: 200px; /* Increased from 80px */
            object-fit: contain;
            margin-right: 20px;
        }

        .container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-gap: 1rem;
            padding: 1rem;
        }

        .section {
            background-color: var(--bg-secondary);
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        button {
            background-color: var(--accent);
            color: var(--text-primary);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        button:hover {
            opacity: 0.9;
        }

        input, textarea {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            border: 1px solid var(--text-secondary);
            padding: 0.5rem;
            border-radius: 4px;
            width: 100%;
            margin-bottom: 1rem;
        }

        .file-list {
            list-style: none;
            padding: 0;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid var(--text-secondary);
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .file-item a {
            color: #ffffff;
            text-decoration: none;
            padding: 5px 10px;
            background-color: var(--accent);
            border-radius: 4px;
            margin-right: 10px;
        }

        .file-item a:hover {
            opacity: 0.9;
        }

        .chat-window {
            height: 300px;
            overflow-y: auto;
            padding: 1rem;
            background-color: var(--bg-primary);
            border-radius: 4px;
            margin-bottom: 1rem;
        }

        .status-message {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 1rem;
            border-radius: 4px;
            animation: fadeOut 3s forwards;
        }

        @keyframes fadeOut {
            0% { opacity: 1; }
            70% { opacity: 1; }
            100% { opacity: 0; visibility: hidden; }
        }

        .chat-container {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem;
            height: 500px;
            display: flex;
            flex-direction: column;
        }

        .chat-history {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 1rem;
            padding: 1rem;
        }

        .chat-input {
            display: flex;
            gap: 0.5rem;
        }

        .chat-input input {
            flex-grow: 1;
            padding: 0.5rem;
            border: 1px solid var(--text-secondary);
            border-radius: 4px;
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .chat-input button {
            padding: 0.5rem 1rem;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .chat-input button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .message {
            margin: 0.5rem 0;
            padding: 0.5rem;
            border-radius: 4px;
        }

        .user-message {
            background: var(--accent);
            color: white;
            margin-left: 20%;
        }

        .bot-message {
            background: var(--bg-primary);
            color: var(--text-primary);
            margin-right: 20%;
        }

        .loading-spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 2px solid var(--text-secondary);
            border-top: 2px solid var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <header>
        <img src="TaxStats AI.png" alt="TaxStats AI Logo" width="80" height="80">
        <h1>TaxStats AI Dashboard</h1>
        <button id="logoutBtn">Logout</button>
    </header>

    <div class="container">
        <!-- Sources Section -->
        <div class="section">
            <h2>Sources</h2>
            <button id="uploadBtn">Upload Document</button>
            <button id="refreshBtn">Refresh Files</button>
            <ul id="fileList" class="file-list"></ul>
        </div>

        <!-- Tax Calculator Section -->
        <div class="section">
            <h2>Tax Calculator</h2>
            <input type="number" id="incomeInput" placeholder="Income">
            <input type="number" id="allowancesInput" placeholder="Allowances">
            <input type="number" id="expensesInput" placeholder="Expenses">
            <button id="calculateBtn">Calculate Tax</button>
            <div id="taxResults"></div>
        </div>

        <!-- AI Assistant Section -->
        <div class="section">
            <h2>AI Assistant</h2>
            <div id="chatWindow" class="chat-window"></div>
            <div style="display: flex; gap: 0.5rem;">
                <input type="text" id="chatInput" placeholder="Type your message...">
                <button id="sendBtn">Send</button>
            </div>
        </div>

        <!-- Tax Return Section -->
        <div class="section">
            <h2>Tax Return Viewer</h2>
            <div id="taxViewer" style="height: 400px; overflow: auto;"></div>
            <div style="display: flex; justify-content: space-between; margin-top: 1rem;">
                <div>
                    <button id="prevPage">Previous</button>
                    <button id="nextPage">Next</button>
                </div>
                <button id="submitReturn">Submit Return</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase initialization
        const firebaseConfig = {
            apiKey: "AIzaSyAYXDpK8_dNn3f_c-n3q7_FCqoed-wRntk",
            authDomain: "taxstats-document-ai.firebaseapp.com",
            projectId: "taxstats-document-ai",
            storageBucket: "taxstats-document-ai.firebasestorage.app",
            messagingSenderId: "532562763606",
            appId: "1:532562763606:web:3d9b6d04e4ed23700600f7"
        };

        // Initialize Firebase and Auth
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const storage = firebase.storage();
        const storageRef = storage.ref();

        // Auth state listener
        let authInitialized = false;
        auth.onAuthStateChanged((user) => {
            authInitialized = true;
            if (!user) {
                window.location.href = '/login.html';
                return;
            }
            refreshFiles();
        });

        // Status message function
        function showStatus(message, type = 'success') {
            const status = document.createElement('div');
            status.className = `status-message ${type}`;
            status.textContent = message;
            document.body.appendChild(status);
            setTimeout(() => status.remove(), 3000);
        }

        // File type validation
        const ALLOWED_TYPES = ['.pdf', '.jpg', '.jpeg', '.png'];

        async function uploadDocument() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = ALLOWED_TYPES.join(',');
            
            fileInput.onchange = async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                // Validate file type
                const fileExt = '.' + file.name.split('.').pop().toLowerCase();
                if (!ALLOWED_TYPES.includes(fileExt)) {
                    showStatus('Invalid file type. Allowed: PDF, JPG, PNG', 'error');
                    return;
                }

                try {
                    const uploadRef = storageRef.child(`uploads/${auth.currentUser.uid}/${file.name}`);
                    await uploadRef.put(file);
                    
                    // Process document
                    const processDocument = firebase.functions().httpsCallable('processDocument');
                    await processDocument({ 
                        filename: file.name,
                        path: uploadRef.fullPath
                    });
                    
                    showStatus('File uploaded and processed successfully');
                    refreshFiles();
                } catch (error) {
                    console.error('Upload error:', error);
                    showStatus(error.message, 'error');
                }
            };

            fileInput.click();
        }

        async function refreshFiles() {
            const fileList = document.getElementById('fileList');
            if (!fileList) return;

            try {
                const uploadsList = await storageRef.child('uploads').listAll();
                fileList.innerHTML = '';

                for (const item of uploadsList.items) {
                    const url = await item.getDownloadURL();
                    const li = document.createElement('li');
                    li.className = 'file-item';
                    li.innerHTML = `
                        <span>${item.name}</span>
                        <div>
                            <a href="${url}" target="_blank">Download</a>
                            <button onclick="deleteFile('${item.fullPath}')">Delete</button>
                        </div>
                    `;
                    fileList.appendChild(li);
                }
            } catch (error) {
                console.error('Refresh error:', error);
                showStatus(error.message, 'error');
            }
        }

        async function deleteFile(filePath) {
            try {
                const fileRef = storageRef.child(filePath);
                await fileRef.delete();
                showStatus('File deleted successfully');
                refreshFiles();
            } catch (error) {
                console.error('Delete error:', error);
                showStatus(error.message, 'error');
            }
        }

        // Chat handler with auth
        let chatHistory = [];

        async function handleChat() {
            try {
                const message = chatInput.value.trim();
                if (!message) return;

                const user = auth.currentUser;
                if (!user) {
                    throw new Error('Not authenticated');
                }

                const token = await user.getIdToken();
                chatBtn.disabled = true;
                
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ message })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                displayChatMessage(message, data.response);
                chatInput.value = '';
                
            } catch (error) {
                console.error('Chat error:', error);
                displayError('Failed to send message. Please try again.');
            } finally {
                chatBtn.disabled = false;
            }
        }

        // Tax calculator
        function calculateTax() {
            const income = parseFloat(document.getElementById('incomeInput').value) || 0;
            const allowances = parseFloat(document.getElementById('allowancesInput').value) || 0;
            const expenses = parseFloat(document.getElementById('expensesInput').value) || 0;

            const taxableIncome = income - allowances - expenses;
            const tax = Math.max(0, taxableIncome * 0.2); // Simple 20% tax rate

            document.getElementById('taxResults').innerHTML = `
                <p>Taxable Income: £${taxableIncome.toFixed(2)}</p>
                <p>Estimated Tax: £${tax.toFixed(2)}</p>
            `;
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Upload and refresh
            document.getElementById('uploadBtn')?.addEventListener('click', uploadDocument);
            document.getElementById('refreshBtn')?.addEventListener('click', refreshFiles);

            // Chat
            const chatInput = document.getElementById('chatInput');
            const sendBtn = document.getElementById('sendBtn');

            if (sendBtn) {
                sendBtn.addEventListener('click', handleChat);
            }

            if (chatInput) {
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        handleChat();
                    }
                });
            }

            // Tax calculator
            document.getElementById('calculateBtn')?.addEventListener('click', calculateTax);

            // Logout
            document.getElementById('logoutBtn')?.addEventListener('click', () => {
                auth.signOut().then(() => {
                    window.location.href = '/login.html';
                });
            });

            // Chat functionality
            const chatInput = document.getElementById('chatInput');
            const chatBtn = document.getElementById('sendChatBtn');
            const chatHistory = document.getElementById('chatHistory');

            async function handleChat() {
                const now = Date.now();
                if (now - lastMessageTime < RATE_LIMIT) {
                    displayError('Please wait before sending another message');
                    return;
                }
                lastMessageTime = now;

                try {
                    const message = chatInput.value.trim();
                    if (!message) return;

                    const user = auth.currentUser;
                    if (!user) throw new Error('Not authenticated');

                    const token = await user.getIdToken();
                    
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ message })
                    });

                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    
                    const data = await response.json();
                    displayChatMessage(message, data.response);
                    chatInput.value = '';
                    
                } catch (error) {
                    console.error('Chat error:', error);
                    displayError('Failed to send message. Please try again.');
                }
            }

            chatBtn?.addEventListener('click', handleChat);
            chatInput?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleChat();
            });
        });

        function displayChatMessage(message, response) {
            const messageDiv = document.createElement('div');
            messageDiv.innerHTML = `
                <p class="user-message">${message}</p>
                <p class="bot-message">${response}</p>
            `;
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        function displayError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }
    </script>
    <script type="module">
        import { initializeApp } from 'firebase/app';
        import { getAuth, onAuthStateChanged } from 'firebase/auth';

        // Firebase configuration
        const firebaseConfig = {
            // Your firebase config here
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // Auth state observer
        onAuthStateChanged(auth, user => {
            const authStatus = document.getElementById('auth-status');
            if (user) {
                authStatus.textContent = `Signed in as ${user.email}`;
                authStatus.className = 'auth-status signed-in';
            } else {
                window.location.href = '/login.html';
            }
        });

        // Token refresh handler
        let tokenRefreshTimeout;
        async function refreshToken() {
            const user = auth.currentUser;
            if (user) {
                await user.getIdToken(true);
                // Schedule next refresh
                tokenRefreshTimeout = setTimeout(refreshToken, 30 * 60 * 1000); // 30 mins
            }
        }

        // Add token refresh mechanism
        let tokenRefreshInterval;
        
        function startTokenRefresh() {
            tokenRefreshInterval = setInterval(async () => {
                const user = auth.currentUser;
                if (user) {
                    try {
                        await user.getIdToken(true);
                    } catch (error) {
                        console.error('Token refresh failed:', error);
                        displayError('Session refresh failed');
                    }
                }
            }, 30 * 60 * 1000); // 30 minutes
        }

        function stopTokenRefresh() {
            clearInterval(tokenRefreshInterval);
        }

        // Add rate limiting for chat
        const RATE_LIMIT = 1000; // 1 second between messages
        let lastMessageTime = 0;

        async function handleChat() {
            const now = Date.now();
            if (now - lastMessageTime < RATE_LIMIT) {
                displayError('Please wait before sending another message');
                return;
            }
            lastMessageTime = now;

            ...existing code...
        }

        window.handleChat = handleChat;
        window.startTokenRefresh = refreshToken;
        window.clearTokenRefresh = () => clearTimeout(tokenRefreshTimeout);
    </script>
</body>
</html>
